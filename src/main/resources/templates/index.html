<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>TZ Whiteboard</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="/templates/dracula.css">
</head>
<body class="nospace">
    <div class="textboard" th:if="${context.request().path() == '/slf'}">
        <style>
            body.nospace {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                grid-gap: 10px;
            }
            .textboard {
                grid-column: 1 / 2;
                grid-row: 1;
            }
            .nospace {
                grid-column: 2 / 2;
                grid-row: 1;
            }
        </style>
        <textarea style="padding-left:10px;width:99%;height:600px;" id="textboard"></textarea>
        <div style="text-align: center;">
            <button
                    th:each="language : ${context.get('languages')}"
                    th:text="${language}"
                    th:value="${language}"
                    onclick="setLanguage(this)"
                    class="btn"
            ></button>
        </div>
    </div>
    <pre class="nospace"><code id="preboard"></code></pre>
    <div id="welcome-psg" style="display:none;">
___  ___  __       __       __
 |  |__  /  ` |__|  /  /\  |__)  /\
 |  |___ \__, |  | /_ /~~\ |  \ /~~\
 __   __        __   __
|__) /  \  /\  |__) |  \
|__) \__/ /~~\ |  \ |__/  o o o
    </div>
    <script src="/templates/sockjs.min.js?v=1"></script>
    <script src="/templates/highlight.pack.js"></script>
    <style>
        .nospace {
            padding : 0px;
            margin : 0px;
        }
        .hljs-ln-numbers {
            width: 30px;
            border-right: 1px solid gray;
        }
        .hljs-ln-code .hljs-ln-line{
            margin-left: 10px;
        }
        .btn{
            min-width: 70px;
            margin : 0px 2px;
            text-transform: uppercase;
        }
        .textselected {
            background-color: cornflowerblue;
            color: white;
        }
    </style>

    <script type="text/javascript">
        var highlightBoard = false;
        var eb = new EventBus(window.location.href.replace(/[a-z]*$/ig, "") + 'eventbus');
        var lastmessage = '';

        function setLastMessage(msg) {
            document.getElementById('preboard').innerHTML = msg || lastmessage;
            if(highlightBoard) {
                hljs.highlightBlock(document.getElementById('preboard'));
                hljs.lineNumbersBlock(document.getElementById('preboard'));
            }
        }
        function welcome() {
            if(lastmessage === '') document.getElementById('preboard').innerHTML = document.getElementById('welcome-psg').innerHTML;
        }
        function setLanguage(btn) {
            eb.publish('board-language', btn.value);
        }
        window.setInterval(function() {
            welcome();
        }, 10000);
        eb.onopen = function() {
            welcome();
            // handle message
            eb.registerHandler('board-message', function(error, message) {
                if(typeof message.body === "undefined") return false;
                lastmessage = message.body.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                setLastMessage();
            });
            // handle language change
            eb.registerHandler('board-language', function(error, message) {
                if(typeof message.body === "undefined") return false;
                if(message.body === 'none') {
                    highlightBoard = false;
                }else {
                    highlightBoard = true;
                    document.getElementById("preboard").className = message.body;
                }
                setLastMessage();
            });
            // handle selection
            eb.registerHandler('board-textselection', function(error, message) {
                if(typeof message.body === "undefined") return false;
                highlightBoard = false;
                setLastMessage(lastmessage.replace(
                    new RegExp('('+message.body.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&")+')', 'g'),
                    '<span class="textselected">$1</span>')
                );
            });
        };

        eb.onclose = function() {
            document.getElementById("preboard").innerHTML = "You are disconnected to the board, please refresh your browser !";
        };

        if(document.getElementById('textboard')) {
            document.getElementById('textboard').onkeyup = function() {
                eb.publish('board-message', this.value);
            };
            document.getElementById('textboard').addEventListener('select', function(e) {
                var sel = window.getSelection().toString();
                if(sel && sel.length > 3) {
                    eb.publish('board-textselection', sel);
                }
            }, false);
        }
    </script>
</body>
</html>